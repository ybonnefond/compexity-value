<html>
  <head>
    <style>
      canvas{
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        cursor: pointer;
      }
      .chartjs-tooltip {
        opacity: 1;
        position: absolute;
        background: rgba(0, 0, 0, .7);
        color: white;
        border-radius: 3px;
        -webkit-transition: all .1s ease;
        transition: all .1s ease;
        pointer-events: none;
        -webkit-transform: translate(-50%, 0);
        transform: translate(-50%, 0);
        padding: 4px;
      }
  
      .chartjs-tooltip-key {
        display: inline-block;
        width: 10px;
        height: 10px;
      }
    </style>
  </head>
<body>
  <div class="chartjs-tooltip" id="tooltip"></div>

  <form action='#' onsubmit="return false;">
    <input type='file' id='input' onchange="load()">
    <input type='button' onclick="load()" value="load">
  </form>

  <br />

  <div>
    <canvas id="chart" style="display: block; width: 100%; height: 100%;" width="800" height="400"></canvas>
  </div>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>

  <script type='text/javascript'>
    const rotation = 200;

    var ctx = document.getElementById('chart').getContext('2d');
    const chart = initChart();

    function getGradient(opacity = 1) {
        return (context) => {
          const chartArea = context.chart.chartArea;
          const grd = context.chart.chart.ctx.createLinearGradient(rotation, 0 - rotation, chartArea.right - rotation, chartArea.bottom + rotation / 2);

          const red = `rgb(250,85,85, ${opacity})`;
          const yellow = `rgb(230,255,140, ${opacity})`;
          const green = `rgb(130,230,100, ${opacity})`;
          grd.addColorStop(0.2, red);
          grd.addColorStop(0.5, yellow);
          grd.addColorStop(0.8, green);
          return grd
        }
    }

    async function parse() {
      input = document.getElementById('input');

      file = input.files[0];
      const raw = String(await file.text());
      const {data, errors, meta } = Papa.parse(raw,  {
        header: true,
        skipEmptyLines: true
      });

      return data;
    }

    function map(data) {
      return data.map((issue) => {
          return {
            status: issue['Status'],
            key: issue['Issue key'],
            summary: issue['Summary'],
            assignee: issue['Assagnee'],
            assignee: issue['Reporter'],
            votes: parseInt(issue['Votes'], 10) || 15,
            value: parseInt(issue['Custom field (Business Value)'], 10) || randomFibo(),
            complexity: parseInt(issue['Custom field (Story Points)'], 10) || randomFibo(),
            link: `https://jira.solocal.com/browse/${issue['Issue key']}`
          };
        });
    }

    function randomFibo() {
      const values = [1, 2, 3, 5, 8];
      const i = Math.floor(Math.random() * values.length);
      return values[i];
    }
    
    function getAxis(title, ticks) {
      return [{
                type: 'category',
                labels: ticks,
                color: 'rgba(0, 0, 0, 0)',
                scaleLabel: {
                  display: true,
                  labelString: title
                }
            }]
    }

    function initChart() {
      var options = {
        aspectRatio: 0.5,
        legend: false,
        tooltips: { 
          mode: 'point'
        },
        scales: {
            xAxes: getAxis('Business Value', [0, 1, 2, 3, 5, 8, 13]),
            yAxes: getAxis('Complexity', [13, 8, 5, 3, 2, 1, 0]),
        },
        tooltips: {
            callbacks: {
              label: function(tooltipItem, data) {
                    var {issue} = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index] || {};
                    return `${issue.key}: ${issue.summary}`;
                }
            }
        },
        onClick: (e) => {
          var elements = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true });
          for(const element of elements) {
            const issue =  chart.data.datasets[element._datasetIndex].data[element._index].issue;
            window.open(issue.link, '_blank');
          }
        },
        elements: {
          point: {
            borderColor: getGradient(),
            backgroundColor: getGradient(),
            hoverBorderColor: getGradient(1),
            hoverBackgroundColor: getGradient(1),

            borderWidth: function(context) {
              return Math.min(Math.max(1, context.datasetIndex + 1), 8);
            },

            hoverBorderWidth: function(context) {
              var value = context.dataset.data[context.dataIndex];
              return Math.round(8 * value.v / 1000);
            },

            radius: function(context) {
              var value = context.dataset.data[context.dataIndex];
              var size = context.chart.width;
              var base = Math.abs(value.v) / 1000;
              return (size / 24) * base;
            }
          }
        }
      };


      return new Chart(ctx, {
          type: 'bubble',
          data: { datasets: [] },
          options
      });
    }
    

    async function load() {
        const data = await parse();
        const issues = map(data);

        chart.data.datasets = [issuesToDataset(issues)];
        chart.update();
    }

    function issuesToDataset(issues) {
      const data = issues.map((issue) => {
        return {
            x: issue.value,
            y: issue.complexity,
            r: issue.votes / 20 * 10 + 5,
            issue
        }
      });

      return { data }
    }
  </script>
</body>
</html>